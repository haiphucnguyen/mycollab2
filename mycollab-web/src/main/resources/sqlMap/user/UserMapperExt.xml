<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.esofthead.mycollab.module.user.dao.UserMapperExt">
        
    <resultMap extends="com.esofthead.mycollab.module.user.dao.UserMapper.BaseResultMap"
                   id="SimpleUserResult" type="com.esofthead.mycollab.module.user.domain.SimpleUser">
        <result column="displayName" jdbcType="VARCHAR" property="displayName" />
        <result column="roleName" jdbcType="VARCHAR" property="roleName" />
        <result column="lastAccessedTime" jdbcType="TIMESTAMP" property="lastAccessedTime"/>
    </resultMap>

    <sql id="querySearchCriteria">
        <if test="displayName != null">
          <![CDATA[
            ${displayName.operation} (concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) like '%${displayName.value}%')
            ]]>
        </if>
        <if test="username != null">
          <![CDATA[
            ${username.operation} s_user.username = #{username.value}
            ]]>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} accountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
    </sql>

    <select id="getTotalCount" resultType="int" parameterType="UserSearchCriteria">
        SELECT count(*) as totalCount FROM s_user
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include refid="querySearchCriteria" />
        </trim>
    </select>

    <select id="findPagableListByCriteria" resultMap="SimpleUserResult"
                parameterType="UserSearchCriteria">
        <![CDATA[
        SELECT s_user.username, s_user.firstname, s_user.lastname, s_user.nickname, s_user.dateofbirth, s_user.password, s_user.email, 
                s_user.website, s_user.registeredTime, s_user.accountId, s_user.countryid, s_user.company, s_user.roleid,
                s_user_preference.lastAccessedTime, s_roles.rolename AS roleName,
                s_user.timezoneid, s_user.registrationSource, s_user.isAdmin, s_user.registerStatus, s_country.countryname as country 
        FROM s_user LEFT OUTER JOIN s_country ON (s_user.countryid=s_country.id)   
                LEFT OUTER JOIN s_user_preference ON (s_user.username = s_user_preference.username)
                LEFT OUTER JOIN s_roles ON (s_roles.id = s_user.roleid)
        ]]>
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include refid="querySearchCriteria" />
        </trim>
    </select>
    
    <delete id="removeKeysWithSession" parameterType="java.util.List">
        <!--WARNING - @mbggenerated-->
        delete from s_user where username IN <foreach close=")" collection="list" index="index" item="item" open="(" separator=","> #{item} </foreach>
    </delete>
</mapper>