<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.common.dao.CommentMapperExt" >

    <resultMap
        id="BaseResultMap"
        extends="com.esofthead.mycollab.common.dao.CommentMapper.BaseResultMap"
        type="com.esofthead.mycollab.common.domain.SimpleComment" >
        
        <result
            column="ownerFullName"
            jdbcType="VARCHAR"
            property="ownerFullName" />
        <collection property="attachments" javaType="ArrayList" columnPrefix="attach_"
                    resultMap="com.esofthead.mycollab.module.file.dao.AttachmentMapper.BaseResultMap"
                    ofType="com.esofthead.mycollab.module.file.domain.Attachment"/>
    </resultMap>
    
    <sql id="querySearchCriteria">
        <if test="type != null ">
            <![CDATA[${type.operation} m_comment.type = '${type.value}' ]]>
        </if>
        <if test="typeid != null ">
            <![CDATA[${typeid.operation} m_comment.typeid = ${typeid.value} ]]>
        </if>
    </sql>
    
    <sql id="selectSimpleComment">
        <![CDATA[
            SELECT m_comment.id, m_comment.comment, m_comment.createdUser, m_comment.createdTime, 
                   m_comment.type, m_comment.typeId, m_comment.sAccountId,
                   concat(s_user.firstname, ' ', LTRIM(IFNULL(s_user.middlename || ' ', '')), s_user.lastname) as ownerFullName,
                   m_attachment.id AS attach_id, m_attachment.type AS attach_type, m_attachment.documentpath AS attach_documentpath, 
                   m_attachment.createdTime AS attach_createdTime, m_attachment.lastUpdatedTime AS attach_lastUpdatedTime, 
                   m_attachment.typeid AS attach_typeid
                FROM m_comment
                    LEFT OUTER JOIN s_user ON m_comment.createdUser = s_user.username
                    LEFT OUTER JOIN m_attachment ON (m_attachment.type='common-comment' AND m_attachment.typeid=m_comment.id)
        ]]>
    </sql>
    
    <sql id="orderStatement">
        ORDER BY <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            createdTime DESC
        ]]>
    </sql>

    <select id="findPagableListByCriteria" parameterType="CommentSearchCriteria"
        resultMap="BaseResultMap">
        <include
            refid="com.esofthead.mycollab.common.dao.CommentMapperExt.selectSimpleComment" />
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 <include
                refid="com.esofthead.mycollab.common.dao.CommentMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
        
    </select>        

</mapper>