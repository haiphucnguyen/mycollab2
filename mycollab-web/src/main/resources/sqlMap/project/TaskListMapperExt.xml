<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.project.dao.TaskListMapperExt" >
    <resultMap
        id="SimpleTaskListResult"
        extends="com.esofthead.mycollab.module.project.dao.TaskListMapper.BaseResultMap"
        type="com.esofthead.mycollab.module.project.domain.SimpleTaskList" >
        <result
            column="milestoneName"
            jdbcType="VARCHAR"
            property="milestoneName" />
        
        <result
            column="ownerFullName"
            jdbcType="VARCHAR"
            property="ownerFullName" />
        <collection property="subTasks" ofType="com.esofthead.mycollab.module.project.domain.SimpleTask"
            resultMap="com.esofthead.mycollab.module.project.dao.TaskMapperExt.TaskResult"
            columnPrefix="subTask_"/>
    </resultMap>   
    
    <sql id="querySearchCriteria" >

        <if test="projectId != null">
            ${projectId.operation} m_prj_task_list.projectid = #{projectId.value,javaType=INTEGER}
        </if>
        
        <if test="status != null">
            ${status.operation} m_prj_task_list.status = #{status.value}
        </if>
    </sql>
    
    <sql id="selectTaskList">
        <![CDATA[SELECT m_prj_task_list.id, m_prj_task_list.name, m_prj_task_list.description, 
                    m_prj_task_list.projectid, m_prj_task_list.createdTime, m_prj_task_list.lastUpdatedTime, 
                    m_prj_task_list.sAccountId, m_prj_task_list.milestoneId, m_prj_task_list.groupIndex,
                    m_prj_task_list.owner, m_prj_task_list.status, m_prj_milestone.name AS milestoneName,
                    concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) AS ownerFullName,
                    m_prj_task.id AS subTask_id, m_prj_task.taskname AS subTask_taskname, m_prj_task.percentagecomplete AS subTask_percentagecomplete, 
                    m_prj_task.startdate AS subTask_startdate, m_prj_task.enddate AS subTask_enddate, m_prj_task.priority AS subTask_priority, 
                    m_prj_task.duration AS subTask_duration, m_prj_task.isestimated AS subTask_isestimated, m_prj_task.projectid AS subTask_projectid, 
                    m_prj_task.deadline AS subTask_deadline, m_prj_task.notes AS subTask_notes, m_prj_task.taskindex AS subTask_taskindex, 
                    m_prj_task.actualStartDate AS subTask_actualStartDate, m_prj_task.actualEndDate AS subTask_actualEndDate, m_prj_task.cost AS subTask_cost, 
                    m_prj_task.actualCost AS subTask_actualCost, m_prj_task.ismilestone AS subTask_ismilestone, m_prj_task.tasklistid AS subTask_tasklistid, 
                    m_prj_task.createdTime AS subTask_createdTime, m_prj_task.lastUpdatedTime AS subTask_lastUpdatedTime, 
                    m_prj_task.assignUser AS subTask_assignUser, m_prj_task.sAccountId AS subTask_sAccountId, m_prj_task.status AS subTask_status,
                    concat(taskUser.firstname, IFNULL(concat(' ', taskUser.middlename, ' '), ' '), taskUser.lastname) AS subTask_assignUserFullName
                    FROM m_prj_task_list
                        LEFT OUTER JOIN s_user ON (s_user.username = m_prj_task_list.owner)
                        LEFT OUTER JOIN m_prj_milestone ON (m_prj_milestone.id = m_prj_task_list.milestoneId)
                        LEFT OUTER JOIN m_prj_task ON (m_prj_task_list.id = m_prj_task.tasklistid)
                        LEFT OUTER JOIN s_user AS taskUser ON (taskUser.username = m_prj_task.assignUser AND m_prj_task.status='Open')
        ]]>
    </sql>
    
    <select
        id="getTotalCount"
        parameterType="TaskListSearchCriteria"
        resultType="int" >
        SELECT count(*) as totalCount FROM m_prj_task_list


        <trim
            prefix="WHERE"
            prefixOverrides="AND | OR " >
            1=1 

            <include refid="com.esofthead.mycollab.module.project.dao.TaskListMapperExt.querySearchCriteria" />
        </trim>
    </select>
    
    <sql id="orderStatement">
        ORDER BY 
        <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_prj_task_list.groupIndex, m_prj_task_list.lastUpdatedTime DESC
        ]]>
    </sql>

    <select
        id="findPagableListByCriteria"
        parameterType="TaskListSearchCriteria"
        resultMap="SimpleTaskListResult" >

        <include refid="com.esofthead.mycollab.module.project.dao.TaskListMapperExt.selectTaskList" />

        <trim
            prefix="WHERE"
            prefixOverrides="AND | OR " >
            1=1 

            <include refid="com.esofthead.mycollab.module.project.dao.TaskListMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
    </select>
    
    <select id="findTaskListById" parameterType="java.lang.Integer"
        resultMap="SimpleTaskListResult">
        <include
            refid="com.esofthead.mycollab.module.project.dao.TaskListMapperExt.selectTaskList" />

        WHERE m_prj_task_list.id=#{taskListId, javaType=INTEGER}
    </select>
</mapper>