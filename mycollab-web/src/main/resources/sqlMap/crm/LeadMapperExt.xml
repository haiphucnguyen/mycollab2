<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.LeadMapperExt">
    <resultMap extends="com.esofthead.mycollab.module.crm.dao.LeadMapper.ResultMapWithBLOBs"
                   id="SimpleLeadResult" type="com.esofthead.mycollab.module.crm.domain.SimpleLead">
        <result column="assignUserFullName" jdbcType="VARCHAR"
                        property="assignUserFullName" />
        <result column="campaignName" jdbcType="VARCHAR" property="campaignName" />
    </resultMap>

    <sql id="querySearchCriteria">
        <if test="campaignName != null">
            ${campaignName.operation} m_crm_campaign.campaignName like '%${campaignName.value}%'
        </if>
        <if test="campaignId != null">
            <![CDATA[
            ${campaignId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_campaign, m_crm_campaigns_leads 
                    WHERE m_crm_campaigns_leads.campaignId=#{campaignId.value,javaType=INTEGER} AND m_crm_campaigns_leads.leadId=m_crm_lead.id
                        AND m_crm_campaign.id=m_crm_campaigns_leads.campaignId) > 0
            ]]>
        </if>
        <if test="referredBy != null">
            <![CDATA[${referredBy.operation} m_crm_lead.referredBy like '%${referredBy.value}%']]>
        </if>
        <if test="leadName != null">
			<![CDATA[
				  ${leadName.operation}
				  	(concat (m_crm_lead.firstname, ' ', m_crm_lead.lastname) like '%${leadName.value}%')
		  	]]>
        </if>
        <if test="accountName != null">
            ${accountName.operation} m_crm_lead.accountName like '%${accountName.value}%'
        </if>
        <if test="assignUserName != null">
            <![CDATA[
                ${assignUserName.operation} concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) like '%${assignUserName.value}%'
            ]]>
        </if>
        <if test="assignUsers != null">
            ${assignUsers.operation} m_crm_lead.assignUser IN
            <foreach close=")" collection="assignUsers.values" item="assignUser"
                         open="(" separator=",">
                #{assignUser}
            </foreach>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_lead.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
        <if test="firstname != null">
            <![CDATA[${firstname.operation} m_crm_lead.firstname like '%${firstname.value}%']]>
        </if>
        <if test="lastname != null">
            <![CDATA[${lastname.operation} m_crm_lead.lastname like '%${lastname.value}%']]>
        </if>
        <if test="anyEmail != null">
            <![CDATA[${anyEmail.operation} m_crm_lead.email like '%${anyEmail.value}%']]>
        </if>
        <if test="anyAddress != null">
            <![CDATA[${anyAddress.operation} m_crm_lead.primAddress like '%${anyAddress.value}%'
            							 OR  m_crm_lead.otherAddress like '%${anyAddress.value}%']]>
        </if>
        <if test="anyCountry != null">
            <![CDATA[${anyCountry.operation} m_crm_lead.primCountry like '%${anyCountry.value}%'
            							 OR  m_crm_lead.otherCountry like '%${anyCountry.value}%']]>
        </if>
        <if test="sources != null">
            ${sources.operation} m_crm_lead.source IN
            <foreach close=")" collection="sources.values" item="source"
                         open="(" separator=",">
                #{source}
            </foreach>
        </if>
        <if test="anyPhone != null">
            <![CDATA[${anyPhone.operation} m_crm_lead.officePhone like '%${anyPhone.value}%'
            							 OR  m_crm_lead.homePhone like '%${anyPhone.value}%'
            							 OR  m_crm_lead.mobile like '%${anyPhone.value}%'
            							 OR  m_crm_lead.otherPhone like '%${anyPhone.value}%']]>
        </if>
        <if test="anyCity != null">
            <![CDATA[${anyCity.operation} m_crm_lead.primCity like '%${anyCity.value}%'
            							 OR  m_crm_lead.otherCity like '%${anyCity.value}%']]>
        </if>
        <if test="anyState != null">
            <![CDATA[${anyState.operation} m_crm_lead.primCity like '%${anyState.value}%'
            							 OR  m_crm_lead.otherState like '%${anyState.value}%']]>
        </if>
        <if test="statuses != null">
            ${statuses.operation} m_crm_lead.status IN
            <foreach close=")" collection="statuses.values" item="status"
                         open="(" separator=",">
                #{status}
            </foreach>
        </if>
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_account, m_crm_accounts_leads 
                WHERE m_crm_account.id = #{accountId.value,javaType=INTEGER} 
                    AND m_crm_lead.id = m_crm_accounts_leads.leadId
                    AND m_crm_account.id = m_crm_accounts_leads.accountId) > 0
                ]]>
        </if>
        <if test="campaignId != null">
            <![CDATA[
            ${campaignId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_campaign, m_crm_campaigns_leads 
                    WHERE m_crm_campaigns_leads.campaignId=#{campaignId.value,javaType=INTEGER} AND m_crm_campaigns_leads.leadId=m_crm_lead.id
                        AND m_crm_campaign.id=m_crm_campaigns_leads.campaignId) > 0
            ]]>
        </if>
        <if test="opportunityId != null">
            <![CDATA[
            ${opportunityId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_opportunity, m_crm_opportunities_leads
                    WHERE m_crm_opportunities_leads.opportunityId=#{opportunityId.value,javaType=INTEGER} AND m_crm_opportunities_leads.leadId=m_crm_lead.id
                        AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
    </sql>

    <sql id="queryTotalCountSearchCriteria">
	
        <if test="id != null">
            <![CDATA[${id.operation} m_crm_lead.id ${id.compareOperator} #{id.value,javaType=INTEGER}]]>
        </if>
	
        <if test="campaignName != null">
            ${campaignName.operation}
            (SELECT COUNT(*)
            FROM m_crm_campaign AS campaign
            WHERE m_crm_lead.campaignId = campaign.id AND campaign.campaignName like '%${campaignName.value}%') > 0
        </if>
        <if test="campaignId != null">
            <![CDATA[
                ${campaignId.operation} m_crm_lead.campaignId = #{campaignId.value,javaType=INTEGER}
                ]]>
        </if>
        <if test="referredBy != null">
            <![CDATA[${referredBy.operation} m_crm_lead.referredBy like '%${referredBy.value}%']]>
        </if>
        <if test="leadName != null">
			<![CDATA[
				  ${leadName.operation}
				  	(concat (m_crm_lead.firstname, ' ', m_crm_lead.lastname) like '%${leadName.value}%')
		  	]]>
        </if>
        <if test="accountName != null">
            <![CDATA[${accountName.operation} m_crm_lead.accountName like '%${accountName.value}%']]>
        </if>
        <if test="assignUsers != null">
            ${assignUsers.operation} m_crm_lead.assignUser IN
            <foreach close=")" collection="assignUsers.values" item="assignUser"
                         open="(" separator=",">
                #{assignUser}
            </foreach>
        </if>
        <if test="assignUserName != null">
            <![CDATA[
                ${assignUserName.operation} concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) like '%${assignUserName.value}%'
            ]]>
        </if>
        <if test="opportunityId != null">
            <![CDATA[
            ${opportunityId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_opportunity, m_crm_opportunities_leads
                    WHERE m_crm_opportunities_leads.opportunityId=#{opportunityId.value,javaType=INTEGER} AND m_crm_opportunities_leads.leadId=m_crm_lead.id
                        AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_lead.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
        <if test="firstname != null">
            <![CDATA[${firstname.operation} m_crm_lead.firstname like '%${firstname.value}%']]>
        </if>
        <if test="lastname != null">
            <![CDATA[${lastname.operation} m_crm_lead.lastname like '%${lastname.value}%']]>
        </if>
        <if test="anyEmail != null">
            <![CDATA[${anyEmail.operation} m_crm_lead.email like '%${anyEmail.value}%']]>
        </if>
        <if test="anyAddress != null">
            <![CDATA[${anyAddress.operation} m_crm_lead.primAddress like '%${anyAddress.value}%'
            							 OR  m_crm_lead.otherAddress like '%${anyAddress.value}%']]>
        </if>
        <if test="sources != null">
            ${sources.operation} m_crm_lead.source IN
            <foreach close=")" collection="sources.values" item="source"
                         open="(" separator=",">
                #{source}
            </foreach>
        </if>
        <if test="anyPhone != null">
            <![CDATA[${anyPhone.operation} m_crm_lead.officePhone like '%${anyPhone.value}%'
            							 OR  m_crm_lead.homePhone like '%${anyPhone.value}%'
            							 OR  m_crm_lead.mobile like '%${anyPhone.value}%'
            							 OR  m_crm_lead.otherPhone like '%${anyPhone.value}%']]>
        </if>
        <if test="anyCity != null">
            <![CDATA[${anyCity.operation} m_crm_lead.primCity like '%${anyCity.value}%'
            							 OR  m_crm_lead.otherCity like '%${anyCity.value}%']]>
        </if>
        <if test="anyState != null">
            <![CDATA[${anyState.operation} m_crm_lead.primCity like '%${anyState.value}%'
            							 OR  m_crm_lead.otherState like '%${anyState.value}%']]>
        </if>
        <if test="statuses != null">
            ${statuses.operation} m_crm_lead.status IN
            <foreach close=")" collection="statuses.values" item="status"
                         open="(" separator=",">
                #{status}
            </foreach>
        </if>
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_account, m_crm_accounts_leads 
                WHERE m_crm_account.id = #{accountId.value,javaType=INTEGER} 
                    AND m_crm_lead.id = m_crm_accounts_leads.leadId
                    AND m_crm_account.id = m_crm_accounts_leads.accountId) > 0
                ]]>
        </if>
    </sql>

    <sql id="selectSimpleLead">
        <![CDATA[
        SELECT m_crm_lead.id, m_crm_lead.campaignId, m_crm_lead.leadSourceDesc, m_crm_lead.statusDesc, m_crm_lead.referredBy, m_crm_lead.prefixName, 
               m_crm_lead.firstname, m_crm_lead.lastname, m_crm_lead.accountName, m_crm_lead.title, m_crm_lead.department, m_crm_lead.isCallable, 
               m_crm_lead.officePhone, m_crm_lead.homePhone, m_crm_lead.mobile, m_crm_lead.otherPhone, m_crm_lead.fax, m_crm_lead.primAddress, 
               m_crm_lead.primState, m_crm_lead.primCity, m_crm_lead.primPostalCode, m_crm_lead.primCountry, m_crm_lead.description,
               m_crm_lead.otherAddress, m_crm_lead.otherState, m_crm_lead.otherCity, m_crm_lead.otherPostalCode, m_crm_lead.otherCountry,
               m_crm_lead.email, m_crm_lead.createdTime, m_crm_lead.createdUser, m_crm_lead.sAccountId, m_crm_lead.assignUser, m_crm_lead.status, 
               m_crm_lead.source, concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) AS assignUserFullName, 
               concat (m_crm_lead.firstname, ' ', m_crm_lead.lastname) AS leadName,
               m_crm_campaign.campaignName, m_crm_lead.website, m_crm_lead.lastUpdatedTime, m_crm_lead.noemployees

        FROM m_crm_lead
               LEFT OUTER JOIN s_user ON (m_crm_lead.assignUser = s_user.username) 
               LEFT OUTER JOIN m_crm_campaign ON (m_crm_lead.campaignId = m_crm_campaign.id)
        ]]>
    </sql>

    <select id="getTotalCount" resultType="int"
                parameterType="LeadSearchCriteria">
        SELECT count(*) as totalCount FROM m_crm_lead
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.queryTotalCountSearchCriteria" />
        </trim>
    </select>
    
    <delete id="removeByCriteria" parameterType="LeadSearchCriteria">
        DELETE FROM m_crm_lead
        <if test="_parameter != null">
            <include refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.queryTotalCountSearchCriteria" />
        </if>
    </delete>
    
    <sql id="orderStatement">
        ORDER BY 
        <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_lead.lastUpdatedTime DESC
        ]]>
    </sql>

    <select id="findPagableListByCriteria" resultMap="SimpleLeadResult"
                parameterType="LeadSearchCriteria">
        <include refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.selectSimpleLead" />
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
    </select>

    <select id="findLeadById" parameterType="int" resultMap="SimpleLeadResult">
        <include refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.selectSimpleLead" />

        WHERE m_crm_lead.id = #{leadId,javaType=INTEGER}
    </select>
	
    <select id="getNextItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MIN(id) FROM m_crm_lead

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
    <select id="getPreviousItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MAX(id) FROM m_crm_lead

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.LeadMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
	
</mapper>