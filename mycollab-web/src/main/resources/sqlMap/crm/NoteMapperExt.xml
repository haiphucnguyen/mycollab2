<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.NoteMapperExt">
    <resultMap extends="com.esofthead.mycollab.module.crm.dao.NoteMapper.BaseResultMap"
                   id="SimpleNoteResult" type="com.esofthead.mycollab.module.crm.domain.SimpleNote">
        <result column="contactName" jdbcType="VARCHAR" property="contactName" />
        <result column="createUserFullName" jdbcType="VARCHAR"
                        property="createUserFullName" />
        
        <collection property="attachments" ofType="com.esofthead.mycollab.module.file.domain.Attachment" 
                    resultMap="com.esofthead.mycollab.module.file.dao.AttachmentMapper.BaseResultMap" columnPrefix="attach_"/>
    </resultMap>

    <sql id="querySearchCriteria">
		
        <if test="type != null">
            ${type.operation} m_crm_note.type = #{type.value}
        </if>
        <if test="typeid != null">
            ${type.operation} m_crm_note.typeid = ${typeid.value}
        </if>
    </sql>
    
    <sql id="selectSimpleNote">
        <![CDATA[
        SELECT m_crm_note.id, m_crm_note.subject, m_crm_note.note, m_crm_note.type, m_crm_note.typeid, m_crm_note.createdTime, 
            m_crm_note.createdUser, m_crm_note.sAccountId, m_crm_note.lastUpdatedTime,
            concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) as createUserFullName,
            m_attachment.id as attach_id, m_attachment.type as attach_type, m_attachment.documentpath as attach_documentpath,
            m_attachment.createdTime as attach_createdTime, m_attachment.lastUpdatedTime as attach_lastUpdatedTime,
            m_attachment.typeid as attach_typeid
            
        FROM m_crm_note
            LEFT OUTER JOIN s_user ON (m_crm_note.createdUser = s_user.username) 
            LEFT OUTER JOIN m_attachment ON (m_attachment.type = 'crm-note' AND m_attachment.typeid=m_crm_note.id)
        ]]>
    </sql>
    
    <sql id="orderStatement">
        ORDER BY <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_note.createdTime DESC
        ]]>
    </sql>
    
    <select id="findPagableListByCriteria" parameterType="NoteSearchCriteria"
        resultMap="SimpleNoteResult">
        <include
            refid="com.esofthead.mycollab.module.crm.dao.NoteMapperExt.selectSimpleNote" />
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 <include
                refid="com.esofthead.mycollab.module.crm.dao.NoteMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
        
    </select>

    <select id="getTotalCount" parameterType="NoteSearchCriteria"
        resultType="java.lang.Integer">
        SELECT count(*) as totalCount FROM m_crm_note
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 <include
                refid="com.esofthead.mycollab.module.crm.dao.NoteMapperExt.querySearchCriteria" />
        </trim>
    </select>
</mapper>