<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.CaseMapperExt">
	<resultMap id="SimpleCaseResult" type="com.esofthead.mycollab.module.crm.domain.SimpleCase"
		extends="com.esofthead.mycollab.module.crm.dao.CaseMapper.BaseResultMap">
		<result column="assignUserFullName" property="assignUserFullName"
			jdbcType="VARCHAR" />
		<result column="accountName" property="accountName" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="querySearchCriteria">
		<if test="subject != null">
            <![CDATA[${subject.operation} m_crm_case.subject LIKE '%${subject.value}%']]>
		</if>
		<if test="assignUser != null">
            <![CDATA[
                ${assignUser.operation} m_crm_case.assignUser = #{assignUser.value}
            ]]>
		</if>
		<if test="assignUserName != null">
            <![CDATA[
               ${assignUserName.operation} concat(s_user.firstname, ' ', LTRIM(IFNULL(s_user.middlename || ' ', '')), s_user.lastname) LIKE '%${assignUserName.value}%'
            ]]>
		</if>
		<if test="accountName != null">
            <![CDATA[${accountName.operation} m_crm_account.accountName like '%${accountName.value}%']]>
		</if>
		<if test="accountId != null">
            <![CDATA[${accountId.operation} m_crm_account.id=#{accountId.value,javaType=INTEGER}]]>
		</if>
		<if test="contactId != null">
            <![CDATA[
                ${contactId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_contact
                 WHERE m_crm_type_relationship.type=8 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_case.id=m_crm_type_relationship.type1id
                     AND m_crm_contact.id=#{contactId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_case.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
		</if>
		<if test="statuses">
			${statuses.operation}
			m_crm_case.status IN
			<foreach collection="statuses.values" item="status" open="("
				close=")" separator=",">
				#{status}
			</foreach>
		</if>
		<if test="assignUsers != null">
			${assignUsers.operation} m_crm_case.assignUser IN
			<foreach collection="assignUsers.values" item="user" open="("
				close=")" separator=",">
				#{user}
			</foreach>
		</if>
		<if test="priorities != null">
			${priorities.operation} m_crm_case.priority IN
			<foreach collection="priorities.values" open="(" close=")"
				separator="," item="priority">
				#{priority}
			</foreach>
		</if>
	</sql>


	<sql id="queryTotalCountSearchCriteria">
	
		<if test="id != null">
            <![CDATA[${id.operation} m_crm_case.id ${id.compareOperator} #{id.value,javaType=INTEGER}]]>
        </if>
	
		<if test="subject">
            <![CDATA[${subject.operation} m_crm_case.subject LIKE '%${subject.value}%']]>
		</if>
		<if test="assignUser != null">
            <![CDATA[
                ${assignUser.operation} m_crm_case.assignUser = #{assignUser.value}
            ]]>
		</if>
		<if test="assignUserName != null">
            <![CDATA[
            ${assignUserName.operation}
            (SELECT COUNT(*)
            FROM s_user
            WHERE m_crm_case.assignUser = s_user.username AND
                  (concat(s_user.firstname, ' ', LTRIM(IFNULL(s_user.middlename || ' ', '')), s_user.lastname) LIKE '%${assignUserName.value}%'))>0
            ]]>
		</if>
		<if test="accountName != null">
            <![CDATA[
            ${accountName.operation}
            (SELECT COUNT(*) 
                FROM m_crm_account 
                WHERE m_crm_account.accountName like '%${accountName.value}%' 
                    AND m_crm_account.id=m_crm_case.accountId) > 0
            ]]>
		</if>
		<if test="accountId != null">
            <![CDATA[
            ${accountId.operation}
            (SELECT COUNT(*) 
                FROM m_crm_account 
                WHERE m_crm_account.id = #{accountId.value,javaType=INTEGER} 
                    AND m_crm_account.id=m_crm_case.accountId) > 0
            ]]>
		</if>
		<if test="contactId != null">
            <![CDATA[
                ${contactId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_contact
                 WHERE m_crm_type_relationship.type=8 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_case.id=m_crm_type_relationship.type1id
                     AND m_crm_contact.id=#{contactId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="statuses != null">
			${statuses.operation}
			m_crm_case.status IN
			<foreach collection="statuses.values" item="status" open="("
				close=")" separator=",">
				#{status}
			</foreach>
		</if>
		<if test="priorities != null">
			${priorities.operation}
			m_crm_case.priority IN
			<foreach collection="priorities.values" item="priority" open="("
				close=")" separator=",">
				#{priority}
			</foreach>
		</if>
		<if test="assignUsers != null">
			${assignUsers.operation}
			m_crm_case.assignUser IN
			<foreach collection="assignUsers.values" item="user" open="("
				close=")" separator=",">
				#{user}
			</foreach>
		</if>
		<if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_case.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
		</if>
	</sql>

	<sql id="selectSimpleCase">
        <![CDATA[
        SELECT m_crm_case.id, m_crm_case.priority, m_crm_case.status, m_crm_case.type, m_crm_case.subject, m_crm_case.description, 
               m_crm_case.resolution, m_crm_case.accountId, m_crm_case.createdTime, m_crm_case.createdUser, m_crm_case.sAccountId, 
               m_crm_case.assignUser, concat(s_user.firstname, ' ', LTRIM(IFNULL(s_user.middlename || ' ', '')), s_user.lastname) as assignUserFullName,
               m_crm_account.accountName, m_crm_case.lastUpdatedTime,  m_crm_case.reason,  m_crm_case.origin, m_crm_case.phonenumber, m_crm_case.email
        FROM m_crm_case
            LEFT OUTER JOIN m_crm_account ON (m_crm_case.accountId = m_crm_account.id)
            LEFT OUTER JOIN s_user ON (m_crm_case.assignUser = s_user.username)
        ]]>
	</sql>
    
    <sql id="orderStatement">
        ORDER BY <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_case.lastUpdatedTime DESC
        ]]>
    </sql>

	<select id="getTotalCount" resultType="int" parameterType="CaseSearchCriteria">
		SELECT count(*) as totalCount FROM m_crm_case
		<trim prefix="WHERE" prefixOverrides="AND | OR ">
			1=1 <include
				refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.queryTotalCountSearchCriteria" />
		</trim>
	</select>
    
    <delete id="removeByCriteria" parameterType="CaseSearchCriteria">
        DELETE FROM m_crm_case
        <if test="_parameter != null">
            <include refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.queryTotalCountSearchCriteria" />
        </if>
    </delete>

	<select id="findPagableListByCriteria" resultMap="SimpleCaseResult"
		parameterType="CaseSearchCriteria">
		<include refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.selectSimpleCase" />
		<trim prefix="WHERE" prefixOverrides="AND | OR ">
			1=1 <include
				refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.querySearchCriteria" />
		</trim>
        <include refid="orderStatement"/>
	</select>
    
    <select id="findCaseById" parameterType="int"
        resultMap="SimpleCaseResult">
        <include refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.selectSimpleCase" />

        WHERE m_crm_case.id=#{caseId,javaType=INTEGER}
    </select>
    
    <select id="getNextItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MIN(id) FROM m_crm_case

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
    <select id="getPreviousItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MAX(id) FROM m_crm_case

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.CaseMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
</mapper>