<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.AccountMapperExt">
    
    <resultMap extends="com.esofthead.mycollab.module.crm.dao.AccountMapper.ResultMapWithBLOBs"
               id="SimpleAccountResult" type="com.esofthead.mycollab.module.crm.domain.SimpleAccount">
        <result column="assignUserFullName" jdbcType="VARCHAR"
                property="assignUserFullName" />
    </resultMap>

	<sql id="querySearchCriteria4MassUpdate">
        <if test="searchCriteria.accountname != null ">
            <![CDATA[${searchCriteria.accountname.operation} m_crm_account.accountName LIKE '%${searchCriteria.accountname.value}%' ]]>
        </if>
        <if test="searchCriteria.assignUser != null">
            <![CDATA[${searchCriteria.assignUser.operation} m_crm_account.assignUser = #{searchCriteria.assignUser.value}]]>
        </if>
        <if test="searchCriteria.assignUserName != null ">
            <![CDATA[${searchCriteria.assignUserName.operation} concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) LIKE '%${searchCriteria.assignUserName.value}%']]>
        </if>
        <if test="searchCriteria.website != null">
            <![CDATA[${searchCriteria.website.operation} m_crm_account.website like '%${searchCriteria.website.value}%']]>
        </if>
        <if test="searchCriteria.anyCity != null">
            ${searchCriteria.anyCity.operation} (shippingCity LIKE '%${searchCriteria.anyCity.value}%' OR city LIKE '%${searchCriteria.anyCity.value}%')
        </if>
        <if test="searchCriteria.types != null">
            ${searchCriteria.types.operation} m_crm_account.type IN
            <foreach close=")" collection="searchCriteria.types.values" item="type"
                     open="(" separator=",">
                #{type}
            </foreach>
        </if>
        <if test="searchCriteria.industries != null">
            ${searchCriteria.industries.operation} m_crm_account.industry IN
            <foreach close=")" collection="searchCriteria.industries.values" item="industry"
                     open="(" separator=",">
                #{industry}
            </foreach>
        </if>

        <if test="searchCriteria.assignUsers != null">
            ${searchCriteria.assignUsers.operation} m_crm_account.assignuser IN
            <foreach close=")" collection="searchCriteria.assignUsers.values" item="user"
                     open="(" separator=",">
                #{user}
            </foreach>
        </if>
        
        <if test="searchCriteria.anyPhone != null">
            ${searchCriteria.anyPhone.operation} (alternatePhone LIKE '%${searchCriteria.anyPhone.value}%' OR phoneOffice LIKE '%${searchCriteria.anyPhone.value}%')
        </if>
        
        <if test="searchCriteria.anyAddress != null">
            ${searchCriteria.anyAddress.operation} (shippingAddress LIKE '%${searchCriteria.anyAddress.value}%' OR billingAddress LIKE '%${searchCriteria.anyAddress.value}%')
        </if>
        
        <if test="searchCriteria.anyMail != null">
            ${searchCriteria.anyMail.operation} m_crm_account.email LIKE '%${searchCriteria.anyMail.value}%'      
        </if>

        <if test="searchCriteria.campaignId != null">
            <![CDATA[
            ${searchCriteria.campaignId.operation} 
            (SELECT COUNT(*) 
                FROM m_crm_campaign, m_crm_campaigns_accounts 
                WHERE m_crm_campaign.id=#{searchCriteria.campaignId.value,javaType=INTEGER} AND m_crm_account.id=m_crm_campaigns_accounts.accountId AND
                    m_crm_campaigns_accounts.campaignId=#{searchCriteria.campaignId.value,javaType=INTEGER}) > 0]]>
        </if>
    </sql>


    <sql id="querySearchCriteria">
        <if test="accountname != null ">
            <![CDATA[${accountname.operation} m_crm_account.accountname LIKE '%${accountname.value}%' ]]>
        </if>
        <if test="assignUser != null">
            <![CDATA[${assignUser.operation} m_crm_account.assignUser = #{assignUser.value}]]>
        </if>
        <if test=" assignUserName != null ">
            <![CDATA[${assignUserName.operation} concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) LIKE '%${assignUserName.value}%']]>
        </if>
        <if test="website != null">
            <![CDATA[${website.operation} m_crm_account.website like '%${website.value}%']]>
        </if>
        <if test="anyCity != null">
            ${anyCity.operation} (shippingCity LIKE '%${anyCity.value}%' OR city LIKE '%${anyCity.value}%')
        </if>
        <if test="types != null">
            ${types.operation} m_crm_account.type IN
            <foreach close=")" collection="types.values" item="type"
                     open="(" separator=",">
                #{type}
            </foreach>
        </if>
        <if test="industries != null">
            ${industries.operation} m_crm_account.industry IN
            <foreach close=")" collection="industries.values" item="industry"
                     open="(" separator=",">
                #{industry}
            </foreach>
        </if>

        <if test="assignUsers != null">
            ${assignUsers.operation} m_crm_account.assignuser IN
            <foreach close=")" collection="assignUsers.values" item="user"
                     open="(" separator=",">
                #{user}
            </foreach>
        </if>
        
        <if test="anyPhone != null">
            ${anyPhone.operation} (alternatePhone LIKE '%${anyPhone.value}%' OR phoneOffice LIKE '%${anyPhone.value}%')
        </if>
        
        <if test="anyAddress != null">
            ${anyAddress.operation} (shippingAddress LIKE '%${anyAddress.value}%' OR billingAddress LIKE '%${anyAddress.value}%')
        </if>
        
        <if test="anyMail != null">
            ${anyMail.operation} m_crm_account.email LIKE '%${anyMail.value}%'      
        </if>

        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_account.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
        <if test="campaignId != null">
            <![CDATA[
            ${campaignId.operation} 
            (SELECT COUNT(*) 
                FROM m_crm_campaign, m_crm_campaigns_accounts 
                WHERE m_crm_campaign.id=#{campaignId.value,javaType=INTEGER} AND m_crm_account.id=m_crm_campaigns_accounts.accountId AND
                    m_crm_campaigns_accounts.campaignId=#{campaignId.value,javaType=INTEGER}) > 0]]>
        </if>
    </sql>

    <sql id="queryTotalCountSearchCriteria">
        <if test="id != null">
            <![CDATA[${id.operation} m_crm_account.id ${id.compareOperator} #{id.value,javaType=INTEGER}]]>
        </if>
        <if test="accountname != null">
             <![CDATA[${accountname.operation} m_crm_account.accountname LIKE '%${accountname.value}%']]>
        </if>
        <if test="assignUser != null"><![CDATA[${assignUser.operation} m_crm_account.assignUser = #{assignUser.value}]]>
        </if>
        <if test="assignUserName != null"><![CDATA[${assignUserName.operation}  
            (SELECT COUNT(*)
            FROM s_user
            WHERE m_crm_account.assignUser = s_user.username AND
                  (concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) LIKE '%${assignUserName.value}%'))>0]]>
        </if>
        <if test="website != null"><![CDATA[${website.operation} m_crm_account.website LiKE '%${website.value}%']]>
        </if>
        <if test="anyCity != null">
            ${anyCity.operation} (shippingCity LIKE '%${anyCity.value}%' OR city LIKE '%${anyCity.value}%')
        </if>
        <if test="types != null">
            ${types.operation} m_crm_account.type IN
            <foreach close=")" collection="types.values" item="type"
                     open="(" separator=",">
                #{type}
            </foreach>
        </if>
        <if test="industries != null">
            ${industries.operation} m_crm_account.industry IN
            <foreach close=")" collection="industries.values" item="industry"
                     open="(" separator=",">
                #{industry}
            </foreach>
        </if>
        <if test="anyPhone != null">
            ${anyPhone.operation} (alternatePhone LIKE '%${anyPhone.value}%' OR phoneOffice LIKE '%${anyPhone.value}%')
        </if>
        <if test="anyAddress != null">
            ${anyAddress.operation} (shippingAddress LIKE '%${anyAddress.value}%' OR billingAddress LIKE '%${anyAddress.value}%')
        </if>
        <if test="anyMail != null">
            ${anyMail.operation} email LIKE '%${anyMail.value}%'        
        </if>
        <if test="assignUsers != null">
            ${assignUsers.operation} m_crm_account.assignUser IN
            <foreach close=")" collection="assignUsers.values" item="user"
                     open="(" separator=",">
                #{user}
            </foreach>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_account.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
        <if test="campaignId != null">
            <![CDATA[
            ${campaignId.operation} 
            (SELECT COUNT(*) 
                FROM m_crm_campaign, m_crm_campaigns_accounts 
                WHERE m_crm_campaign.id=#{campaignId.value,javaType=INTEGER} AND m_crm_account.id=m_crm_campaigns_accounts.accountId AND
                    m_crm_campaigns_accounts.campaignId=#{campaignId.value,javaType=INTEGER}) > 0]]>
        </if>
    </sql>

    <sql id="selectSimpleAccount">
        <![CDATA[
        SELECT m_crm_account.id, m_crm_account.accountName, m_crm_account.website, m_crm_account.phoneOffice, 
               m_crm_account.fax, m_crm_account.alternatePhone, m_crm_account.annualRevenue, m_crm_account.billingAddress, 
               m_crm_account.city, m_crm_account.postalCode, m_crm_account.billingCountry, m_crm_account.description, m_crm_account.state, 
               m_crm_account.email, m_crm_account.ownership, m_crm_account.shippingAddress, m_crm_account.shippingCity, m_crm_account.shippingPostalCode, 
               m_crm_account.shippingCountry, m_crm_account.shippingState, m_crm_account.numemployees, m_crm_account.createdTime,
               m_crm_account.lastUpdatedTime,
               m_crm_account.createdUser, m_crm_account.sAccountId, m_crm_account.assignUser, m_crm_account.type, m_crm_account.industry,
               concat(s_user.firstname, ' ', LTRIM(concat(IFNULL(s_user.middlename, ''), ' ')), s_user.lastname) as assignUserFullName
        FROM m_crm_account
            LEFT OUTER JOIN s_user ON m_crm_account.assignUser = s_user.username
        ]]>
    </sql>
    
    <sql id="orderStatement">
        ORDER BY 
        <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_account.lastUpdatedTime DESC
        ]]>
    </sql>

    <select id="findPagableListByCriteria" parameterType="AccountSearchCriteria"
            resultMap="SimpleAccountResult">
        <include
            refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.selectSimpleAccount" />
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include
                refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
        
    </select>

    <select id="getTotalCount" parameterType="AccountSearchCriteria"
            resultType="java.lang.Integer">
        SELECT count(*) as totalCount FROM m_crm_account
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include
                refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.queryTotalCountSearchCriteria" />
        </trim>
    </select>
    
    <delete id="removeByCriteria" parameterType="AccountSearchCriteria">
        DELETE FROM m_crm_account
        <if test="_parameter != null">
            <trim prefix="WHERE" prefixOverrides="AND | OR ">
                1=1  
                <include refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.queryTotalCountSearchCriteria" />
            </trim>
        </if>
    </delete>

    <select id="findAccountById" parameterType="java.lang.Integer"
            resultMap="SimpleAccountResult">
        <include
            refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.selectSimpleAccount" />

        WHERE m_crm_account.id=#{accountId, javaType=INTEGER}
    </select>
    
    <select id="getNextItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MIN(id) FROM m_crm_account

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
    <select id="getPreviousItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MAX(id) FROM m_crm_account

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
	<!-- Here for Mass Update -->
    <update id="upateAccountBySearchCriteria" parameterType="map">
    	<include refid="com.esofthead.mycollab.module.crm.dao.AccountMapper.massUpdateWithSessionSql"/>
    	<if test="searchCriteria != null">
       		<trim prefix="WHERE" prefixOverrides="AND | OR ">
           		 1=1 
           		 <include refid="com.esofthead.mycollab.module.crm.dao.AccountMapperExt.querySearchCriteria4MassUpdate" />
        	</trim>
    	</if>
    </update>
</mapper>