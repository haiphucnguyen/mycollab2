<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.ContactMapperExt">
	<resultMap extends="com.esofthead.mycollab.module.crm.dao.ContactMapper.BaseResultMap"
		id="SimpleContactResult" type="com.esofthead.mycollab.module.crm.domain.SimpleContact">
		<result column="assignUserFullName" jdbcType="VARCHAR"
			property="assignUserFullName" />
		<result column="accountName" jdbcType="VARCHAR" property="accountName" />
	</resultMap>

	<sql id="querySearchCriteria">
		<if test="contactName != null">
            <![CDATA[${contactName.operation} (m_crm_contact.firstname like '%${contactName.value}%' OR m_crm_contact.lastname like '%${contactName.value}%')]]>
		</if>
		<if test="accountName != null">
			${accountName.operation} (m_crm_account.accountName like '%${accountName.value}%')
        </if>
		<if test="accountId != null">
            <![CDATA[
                ${accountId.operation} m_crm_contact.accountId = #{accountId.value,javaType=INTEGER}
                ]]>
		</if>
		<if test="opportunityId != null">
            <![CDATA[${opportunityId.operation}
                (SELECT COUNT(*) 
                    FROM m_crm_type_relationship, m_crm_opportunity
                    WHERE m_crm_type_relationship.type=2 AND m_crm_contact.id= m_crm_type_relationship.type1id 
                        AND m_crm_type_relationship.type2id=m_crm_opportunity.id 
                        AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
             ]]>
		</if>
		<if test="contractId != null">
            <![CDATA[
                ${contractId.operation}
                (SELECT COUNT(*) 
                    FROM m_crm_type_relationship, m_crm_contract
                    WHERE m_crm_type_relationship.type=7 
                        AND m_crm_contact.id=m_crm_type_relationship.type2id 
                        AND m_crm_contract.id=m_crm_type_relationship.type1id
                        AND m_crm_contract.id=#{contractId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="caseId != null">
            <![CDATA[
                ${caseId.operation}
                (SELECT COUNT(*) 
                    FROM m_crm_type_relationship, m_crm_case
                    WHERE m_crm_type_relationship.type=8 
                        AND m_crm_contact.id=m_crm_type_relationship.type2id 
                        AND m_crm_case.id=m_crm_type_relationship.type1id
                        AND m_crm_case.id=#{caseId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="targetListId != null">
            <![CDATA[
                ${targetListId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_target_list
                 WHERE m_crm_type_relationship.type=11 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_target_list.id=m_crm_type_relationship.type1id
                     AND m_crm_target_list.id=#{targetListId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="assignUserName != null">
            <![CDATA[
            ${assignUserName.operation}
            concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) like '%${assignUserName.value}%'
            ]]>
		</if>
		<if test="assignUser != null">
            <![CDATA[
            ${assignUser.operation}
            m_crm_contact.assignUser = #{assignUser.value}
            ]]>
		</if>
		<if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_contact.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
		</if>
	</sql>


	<sql id="queryTotalCountSearchCriteria">
	    <if test="accountName != null">
            <![CDATA[
            ${accountName.operation}
            (SELECT COUNT(*)
            FROM m_crm_account 
            WHERE
                m_crm_account.accountName like '%${accountName.value}%' AND
                m_crm_account.id=m_crm_contact.accountId) > 0
                ]]>
        </if>
		<if test="contactName != null"><![CDATA[${contactName.operation} (m_crm_contact.firstname like '%${contactName.value}%' OR m_crm_contact.lastname like '%${contactName.value}%')]]></if>
		
		<if test="accountId != null">
            <![CDATA[
                ${accountId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_account 
                WHERE m_crm_account.id = #{accountId.value,javaType=INTEGER} 
                    AND m_crm_account.id=m_crm_contact.accountId) > 0
                ]]>
		</if>
		<if test="opportunityId != null">
            <![CDATA[
                ${opportunityId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_type_relationship, m_crm_opportunity
                WHERE m_crm_type_relationship.type=2 
                    AND m_crm_contact.id= m_crm_type_relationship.type1id 
                    AND m_crm_type_relationship.type2id=m_crm_opportunity.id 
                    AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
             ]]>
		</if>
		<if test="contractId != null">
            <![CDATA[
                ${contractId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_contract
                 WHERE m_crm_type_relationship.type=7 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_contract.id=m_crm_type_relationship.type1id
                     AND m_crm_contract.id=#{contractId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="caseId != null">
            <![CDATA[
                ${caseId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_case
                 WHERE m_crm_type_relationship.type=8 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_case.id=m_crm_type_relationship.type1id
                     AND m_crm_case.id=#{caseId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="targetListId != null">
            <![CDATA[
                ${targetListId.operation}
                (SELECT COUNT(*) 
                 FROM m_crm_type_relationship, m_crm_target_list
                 WHERE m_crm_type_relationship.type=11 
                     AND m_crm_contact.id=m_crm_type_relationship.type2id 
                     AND m_crm_target_list.id=m_crm_type_relationship.type1id
                     AND m_crm_target_list.id=#{targetListId.value,javaType=INTEGER}) > 0
            ]]>
		</if>
		<if test="assignUserName != null">
            <![CDATA[
                ${assignUserName.operation}
                (SELECT COUNT(*) FROM s_user AS user
                WHERE m_crm_contact.assignUser = user.username 
                   AND (concat(user.firstname, IFNULL(concat(' ', user.middlename, ' '), ' '), user.lastname) like '%${assignUserName.value}%') ) > 0
            ]]>
		</if>
		<if test="assignUser != null">
            <![CDATA[
            ${assignUser.operation}
            m_crm_contact.assignUser = #{assignUser.value}
            ]]>
		</if>
		<if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_contact.sAccountId = #{saccountid.value,javaType=int}]]>
		</if>
	</sql>

	<sql id="selectSimpleContact">
        <![CDATA[
        SELECT m_crm_contact.id, m_crm_contact.prefix, m_crm_contact.firstname, m_crm_contact.lastname, m_crm_contact.accountId, 
               m_crm_contact.leadSource, m_crm_contact.campaignId, m_crm_contact.isCallable, m_crm_contact.officePhone, m_crm_contact.mobile, 
               m_crm_contact.homePhone, m_crm_contact.otherPhone, m_crm_contact.fax, m_crm_contact.birthday, m_crm_contact.assistant, 
               m_crm_contact.primAddress, m_crm_contact.primCity, m_crm_contact.primState, m_crm_contact.primPostalCode, m_crm_contact.primCountry, 
               m_crm_contact.otherAddress, m_crm_contact.otherCity, m_crm_contact.otherState, m_crm_contact.otherPostalCode, m_crm_contact.otherCountry, 
               m_crm_contact.description, m_crm_contact.title, m_crm_contact.assistantPhone, m_crm_contact.email, m_crm_contact.department, 
               m_crm_contact.createdTime, m_crm_contact.createdUser, m_crm_contact.sAccountId, m_crm_contact.assignUser, 
               concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) as assignUserFullName,
               m_crm_account.accountName, m_crm_account.lastUpdatedTime

        FROM m_crm_contact 
               LEFT OUTER JOIN m_crm_account ON (m_crm_contact.accountId = m_crm_account.id) 
               LEFT OUTER JOIN s_user ON (m_crm_contact.assignUser = s_user.username)
        ]]>
	</sql>

	<select id="getTotalCount" resultType="int"
		parameterType="ContactSearchCriteria">
		SELECT count(*) as totalCount FROM m_crm_contact
		<trim prefix="WHERE" prefixOverrides="AND | OR ">
			1=1 <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria" />
		</trim>
	</select>
    
    <delete id="removeByCriteria" parameterType="ContactSearchCriteria">
        DELETE FROM m_crm_contact
        <if test="_parameter != null">
            <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria" />
        </if>
    </delete>
    
    <sql id="orderStatement">
        ORDER BY <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_contact.lastUpdatedTime DESC
        ]]>
    </sql>

	<select id="findPagableListByCriteria" resultMap="SimpleContactResult"
		parameterType="ContactSearchCriteria">
		<include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.selectSimpleContact" />
		<trim prefix="WHERE" prefixOverrides="AND |OR ">
			1=1 <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.querySearchCriteria" />
		</trim>
        <include refid="orderStatement"/>
	</select>

	<select id="findContactById" parameterType="int"
		resultMap="SimpleContactResult">
		<include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.selectSimpleContact" />

		WHERE m_crm_contact.id=#{contactId,javaType=INTEGER}
	</select>
</mapper>