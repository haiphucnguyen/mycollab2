<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.ContactMapperExt">
    <resultMap extends="com.esofthead.mycollab.module.crm.dao.ContactMapper.BaseResultMap"
                   id="SimpleContactResult" type="com.esofthead.mycollab.module.crm.domain.SimpleContact">
        <result column="assignUserFullName" jdbcType="VARCHAR"
                        property="assignUserFullName" />
        <result column="contactName" jdbcType="VARCHAR" property="contactName" />
        <collection columnPrefix="account_" ofType="com.esofthead.mycollab.module.crm.domain.Account" 
                    property="accounts" resultMap="com.esofthead.mycollab.module.crm.dao.AccountMapper.BaseResultMap"/> 
    </resultMap>

    <sql id="querySearchCriteria">
        <if test="contactName != null">
            <![CDATA[
                ${contactName.operation} (concat (m_crm_contact.firstname, ' ', m_crm_contact.lastname) like '%${contactName.value}%' )
            ]]>
        </if>
        <if test="accountName != null">
            <![CDATA[${accountName.operation} (m_crm_account.accountName like '%${accountName.value}%')]]>
        </if>
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation} m_crm_account.id ${accountId.compareOperator} #{accountId.value,javaType=INTEGER}
            ]]>
        </if>
        <if test="assignUserName != null">
            <![CDATA[
            ${assignUserName.operation}
            concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) like '%${assignUserName.value}%'
            ]]>
        </if>
        <if test="assignUsers != null">
            <![CDATA[${assignUsers.operation} m_crm_contact.assignUser IN ]]>
            <foreach close=")" collection="assignUsers.values" item="assignUser"
                         open="(" separator=",">
                <![CDATA[#{assignUser}]]>
            </foreach>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_contact.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
        <if test="firstname != null">
            <![CDATA[${firstname.operation} m_crm_contact.firstname like '%${firstname.value}%']]>
        </if>
        <if test="lastname != null">
            <![CDATA[${lastname.operation} m_crm_contact.lastname like '%${lastname.value}%']]>
        </if>
        <if test="anyEmail != null">
            <![CDATA[${anyEmail.operation} m_crm_contact.email like '%${anyEmail.value}%']]>
        </if>
        <if test="anyAddress != null">
            <![CDATA[${anyAddress.operation} m_crm_contact.primAddress like '%${anyAddress.value}%' OR m_crm_contact.otherAddress like '%${anyAddress.value}%']]>
        </if>
        <if test="anyState != null">
            <![CDATA[${anyState.operation} m_crm_contact.primState like '%${anyState.value}%' OR m_crm_contact.otherState like '%${anyState.value}%']]>
        </if>
        <if test="countries != null">
            <![CDATA[${countries.operation} m_crm_contact.primCountry IN]]>
            <foreach close=")" collection="countries.values" item="priCountry"
                         open="(" separator=",">
                #{priCountry}
            </foreach>
            OR m_crm_contact.otherCountry IN
            <foreach close=")" collection="countries.values" item="otherCountry"
                         open="(" separator=",">
                #{otherCountry}
            </foreach>
        </if>
        <if test="anyPhone != null">
            <![CDATA[${anyPhone.operation} m_crm_contact.officePhone like '%${anyPhone.value}%' 
            							OR m_crm_contact.mobile like '%${anyPhone.value}%'
            							OR m_crm_contact.homePhone like '%${anyPhone.value}%'
            							OR m_crm_contact.otherPhone like '%${anyPhone.value}%'
            							OR m_crm_contact.assistantPhone like '%${anyPhone.value}%']]>
        </if>
        <if test="anyCity != null">
            <![CDATA[${anyCity.operation} m_crm_contact.primCity like '%${anyCity.value}%' OR m_crm_contact.otherCity like '%${anyCity.value}%']]>
        </if>
        <if test="anyPostalCode != null">
            <![CDATA[${anyPostalCode.operation} m_crm_contact.primPostalCode like '%${anyPostalCode.value}%' OR m_crm_contact.otherPostalCode like '%${anyPostalCode.value}%']]>
        </if>
        <if test="leadSources != null">
            ${leadSources.operation} m_crm_contact.leadSource IN
            <foreach close=")" collection="leadSources.values" item="leadSource"
                         open="(" separator=",">
                #{leadSource}
            </foreach>
        </if>
        <if test="campaignId != null">
            <![CDATA[${campaignId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_campaign, m_crm_campaigns_contacts 
                    WHERE m_crm_campaigns_contacts.campaignId=#{campaignId.value,javaType=INTEGER} 
                        AND m_crm_campaigns_contacts.contactId=m_crm_contact.id
                        AND m_crm_campaign.id=#{campaignId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
        <if test="opportunityId != null">
            <![CDATA[
                ${opportunityId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_opportunity, m_crm_opportunities_contacts 
                    WHERE m_crm_opportunities_contacts.opportunityId=#{opportunityId.value,javaType=INTEGER} 
                        AND m_crm_opportunities_contacts.contactId=m_crm_contact.id 
                        AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
    </sql>


    <sql id="queryTotalCountSearchCriteria">
    	<if test="id != null">
            <![CDATA[${id.operation} m_crm_contact.id ${id.compareOperator} #{id.value,javaType=INTEGER}]]>
        </if>
        
        <if test="accountName != null">
            <![CDATA[
            ${accountName.operation}
            (SELECT COUNT(*)
            FROM m_crm_account, m_crm_accounts_contacts
            WHERE
                m_crm_accounts_contacts.accountId = m_crm_account.id
                AND m_crm_accounts_contacts.contactId = m_crm_contact.id
                AND m_crm_account.accountName like '%${accountName.value}%') > 0
                ]]>
        </if>
        <if test="contactName != null">
            <![CDATA[
                ${contactName.operation} (concat (m_crm_contact.firstname, ' ', m_crm_contact.lastname) like '%${contactName.value}%')
            ]]>
        </if>
		
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_account, m_crm_accounts_contacts 
                WHERE m_crm_account.id ${accountId.compareOperator} #{accountId.value,javaType=INTEGER} 
                    AND m_crm_contact.id = m_crm_accounts_contacts.contactId
                    AND m_crm_account.id = m_crm_accounts_contacts.accountId) > 0
                ]]>
        </if>
        <if test="assignUserName != null">
            <![CDATA[
                ${assignUserName.operation}
                (SELECT COUNT(*) FROM s_user AS user
                WHERE m_crm_contact.assignUser = user.username 
                   AND (concat(user.firstname, IFNULL(concat(' ', user.middlename, ' '), ' '), user.lastname) like '%${assignUserName.value}%') ) > 0
            ]]>
        </if>
        <if test="assignUsers != null">
            ${assignUsers.operation} m_crm_contact.assignUser IN
            <foreach close=")" collection="assignUsers.values" item="assignUser"
                         open="(" separator=",">
                #{assignUser}
            </foreach>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_contact.sAccountId = #{saccountid.value,javaType=int}]]>
        </if>
        <if test="firstname != null">
            <![CDATA[${firstname.operation} m_crm_contact.firstname like '%${firstname.value}%']]>
        </if>
        <if test="lastname != null">
            <![CDATA[${lastname.operation} m_crm_contact.lastname like '%${lastname.value}%']]>
        </if>
        <if test="anyEmail != null">
            <![CDATA[${anyEmail.operation} m_crm_contact.email like '%${anyEmail.value}%']]>
        </if>
        <if test="anyAddress != null">
            <![CDATA[${anyAddress.operation} m_crm_contact.primAddress like '%${anyAddress.value}%' OR m_crm_contact.otherAddress like '%${anyAddress.value}%']]>
        </if>
        <if test="anyState != null">
            <![CDATA[${anyState.operation} m_crm_contact.primState like '%${anyState.value}%' OR m_crm_contact.otherState like '%${anyState.value}%']]>
        </if>
        <if test="countries != null">
            ${countries.operation} m_crm_contact.primCountry IN
            <foreach close=")" collection="countries.values" item="priCountry"
                         open="(" separator=",">
                #{priCountry}
            </foreach>
            OR m_crm_contact.otherCountry IN
            <foreach close=")" collection="countries.values" item="otherCountry"
                         open="(" separator=",">
                #{otherCountry}
            </foreach>
        </if>
        <if test="anyPhone != null">
            <![CDATA[${anyPhone.operation} m_crm_contact.officePhone like '%${anyPhone.value}%' 
            							OR m_crm_contact.mobile like '%${anyPhone.value}%'
            							OR m_crm_contact.homePhone like '%${anyPhone.value}%'
            							OR m_crm_contact.otherPhone like '%${anyPhone.value}%'
            							OR m_crm_contact.assistantPhone like '%${anyPhone.value}%']]>
        </if>
        <if test="anyCity != null">
            <![CDATA[${anyCity.operation} m_crm_contact.primCity like '%${anyCity.value}%' OR m_crm_contact.otherCity like '%${anyCity.value}%']]>
        </if>
        <if test="anyPostalCode != null">
            <![CDATA[${anyPostalCode.operation} m_crm_contact.primPostalCode like '%${anyPostalCode.value}%' OR m_crm_contact.otherPostalCode like '%${anyPostalCode.value}%']]>
        </if>
        <if test="leadSources != null">
            ${leadSources.operation} m_crm_contact.leadSource IN
            <foreach close=")" collection="leadSources.values" item="leadSource"
                         open="(" separator=",">
                #{leadSource}
            </foreach>
        </if>
        <if test="campaignId != null">
            <![CDATA[${campaignId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_campaign, m_crm_campaigns_contacts 
                    WHERE m_crm_campaigns_contacts.campaignId=#{campaignId.value,javaType=INTEGER} 
                        AND m_crm_campaigns_contacts.contactId=m_crm_contact.id
                        AND m_crm_campaign.id=#{campaignId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
        <if test="opportunityId != null">
            <![CDATA[
                ${opportunityId.operation} 
                (SELECT COUNT(*) 
                    FROM m_crm_opportunity, m_crm_opportunities_contacts 
                    WHERE m_crm_opportunities_contacts.opportunityId=#{opportunityId.value,javaType=INTEGER} 
                        AND m_crm_opportunities_contacts.contactId=m_crm_contact.id 
                        AND m_crm_opportunity.id=#{opportunityId.value,javaType=INTEGER}) > 0
            ]]>
        </if>
    </sql>

    <sql id="selectSimpleContact">
        <![CDATA[
        SELECT m_crm_contact.id, m_crm_contact.prefix, m_crm_contact.firstname, m_crm_contact.lastname, m_crm_account.id AS accountId, 
               m_crm_contact.leadSource, m_crm_contact.campaignId, m_crm_contact.isCallable, m_crm_contact.officePhone, m_crm_contact.mobile, 
               m_crm_contact.homePhone, m_crm_contact.otherPhone, m_crm_contact.fax, m_crm_contact.birthday, m_crm_contact.assistant, 
               m_crm_contact.primAddress, m_crm_contact.primCity, m_crm_contact.primState, m_crm_contact.primPostalCode, m_crm_contact.primCountry, 
               m_crm_contact.otherAddress, m_crm_contact.otherCity, m_crm_contact.otherState, m_crm_contact.otherPostalCode, m_crm_contact.otherCountry, 
               m_crm_contact.description, m_crm_contact.title, m_crm_contact.assistantPhone, m_crm_contact.email, m_crm_contact.department, 
               m_crm_contact.createdTime, m_crm_contact.createdUser, m_crm_contact.sAccountId, m_crm_contact.assignUser, 
               concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) as assignUserFullName,
               concat (m_crm_contact.firstname, ' ', m_crm_contact.lastname) AS contactName,
               m_crm_contact.lastUpdatedTime, m_crm_account.id AS account_id, m_crm_account.accountName as account_accountName

        FROM m_crm_contact 
               LEFT OUTER JOIN m_crm_accounts_contacts ON (m_crm_contact.id = m_crm_accounts_contacts.contactId)
               LEFT OUTER JOIN m_crm_account ON (m_crm_accounts_contacts.accountId = m_crm_account.id) 
               LEFT OUTER JOIN s_user ON (m_crm_contact.assignUser = s_user.username)
        ]]>
    </sql>

    <select id="getTotalCount" resultType="int"
                parameterType="ContactSearchCriteria">
        SELECT count(*) as totalCount FROM m_crm_contact
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria" />
        </trim>
    </select>
    
    <delete id="removeByCriteria" parameterType="ContactSearchCriteria">
        DELETE FROM m_crm_contact
        <if test="_parameter != null">
            <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria" />
        </if>
    </delete>
    
    <sql id="orderStatement">
        ORDER BY 
        <if test="orderByField != null">${orderByField} ${sortDirection}, </if>
        <![CDATA[
            m_crm_contact.lastUpdatedTime DESC
        ]]>
    </sql>

    <select id="findPagableListByCriteria" resultMap="SimpleContactResult"
                parameterType="ContactSearchCriteria">
        <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.selectSimpleContact" />
        <trim prefix="WHERE" prefixOverrides="AND |OR ">
            1=1 
            <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.querySearchCriteria" />
        </trim>
        <include refid="orderStatement"/>
    </select>

    <select id="findContactById" parameterType="int"
                resultMap="SimpleContactResult">
        <include refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.selectSimpleContact" />

        WHERE m_crm_contact.id=#{contactId,javaType=INTEGER}
        LIMIT 1
    </select>
    
     <select id="getNextItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MIN(id) FROM m_crm_contact

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
    <select id="getPreviousItemKey" parameterType="map" resultType="java.lang.Integer">
        SELECT MAX(id) FROM m_crm_contact

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 
            <include 
                refid="com.esofthead.mycollab.module.crm.dao.ContactMapperExt.queryTotalCountSearchCriteria"/>
        </trim>
    </select>
    
</mapper>