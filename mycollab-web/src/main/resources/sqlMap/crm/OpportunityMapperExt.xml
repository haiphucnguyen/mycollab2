<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.esofthead.mycollab.module.crm.dao.OpportunityMapperExt">
	<resultMap extends="com.esofthead.mycollab.module.crm.dao.OpportunityMapper.BaseResultMap"
		id="SimpleOpportunityResult" type="com.esofthead.mycollab.module.crm.domain.SimpleOpportunity">
		<result column="accountName" jdbcType="VARCHAR" property="accountName" />
		<result column="campaignName" jdbcType="VARCHAR" property="campaignName" />
		<result column="assignUserFullName" jdbcType="VARCHAR"
			property="assignUserFullName" />
	</resultMap>
	
	<sql id="querySearchCriteria">
        <if test="opportunityName != null">
            <![CDATA[${opportunityName.operation} m_crm_opportunity.opportunityName like '%${opportunityName.value}%']]>
        </if>
        <if test="accountName != null">
            <![CDATA[
            ${accountName.operation}
            m_crm_account.accountName like '%${accountName.value}%']]>
        </if>
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation} m_crm_opportunity.accountid = #{accountId.value,javaType=INTEGER}
                ]]>
        </if>
        <if test="contactId != null">
            <![CDATA[
                ${contactId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_contact, m_crm_type_relationship
                WHERE m_crm_opportunity.id=m_crm_type_relationship.type2id 
                      AND m_crm_type_relationship.type='2'
                      AND m_crm_contact.id=#{contactId.value,javaType=INTEGER}
                      AND m_crm_type_relationship.type1id=m_crm_contact.id) > 0
            ]]>
        </if>
        <if test="campaignName != null">
            <![CDATA[
            ${campaignName.operation} m_crm_campaign.campaignName like '%${campaignName.value}%'
            ]]>
        </if>
        <if test="assignUserName != null">
            <![CDATA[
            ${assignUserName.operation} concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) like '%${assignUserName.value}%'
            ]]>
        </if>
        <if test="assignUser != null">
            <![CDATA[
            ${assignUser.operation} m_crm_opportunity.assignUser = #{assignUser.value}
            ]]>
        </if>
        <if test="quoteId != null">
          <![CDATA[
            ${quoteId.operation}
              (SELECT COUNT(*) FROM m_crm_quote, m_crm_type_relationship 
                  WHERE m_crm_type_relationship.type=8
                        AND m_crm_type_relationship.type1id=m_crm_quote.id
                        AND m_crm_quote.id=#{quoteId.value,javaType=INTEGER}
                        AND m_crm_type_relationship.type2id=m_crm_opportunity.id) > 0
          ]]>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_opportunity.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
    </sql>

    <sql id="queryTotalCountSearchCriteria">
        <if test="opportunityName != null">
            <![CDATA[${opportunityName.operation} m_crm_opportunity.opportunityName like '%${opportunityName.value}%']]>
        </if>
        <if test="accountName != null">
            <![CDATA[
            ${accountName.operation}
            (SELECT COUNT(*)
            FROM m_crm_account 
            WHERE m_crm_opportunity.accountid = m_crm_account.id 
                AND m_crm_account.accountName like '%${accountName.value}%') > 0
                ]]>
        </if>
        <if test="accountId != null">
            <![CDATA[
                ${accountId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_account 
                WHERE m_crm_opportunity.accountid = m_crm_account.id 
                    AND m_crm_account.id = #{accountId.value,javaType=INTEGER}) > 0
                ]]>
        </if>
        <if test="contactId != null">
            <![CDATA[
                ${contactId.operation}
                (SELECT COUNT(*) 
                FROM m_crm_contact, m_crm_type_relationship
                WHERE m_crm_opportunity.id=m_crm_type_relationship.type2id 
                      AND m_crm_type_relationship.type='2'
                      AND m_crm_contact.id=#{contactId.value,javaType=INTEGER}
                      AND m_crm_type_relationship.type1id=m_crm_contact.id) > 0
            ]]>
        </if>
        <if test="campaignName != null">
            <![CDATA[
            ${campaignName.operation}
            (SELECT COUNT(*) 
            FROM m_crm_campaign 
            WHERE m_crm_opportunity.campaignid = m_crm_campaign.id 
                AND m_crm_campaign.campaignName like '%${campaignName.value}%') > 0
                ]]>
        </if>
        <if test="quoteId != null">
          <![CDATA[
                ${quoteId.operation}
              (SELECT COUNT(*) FROM m_crm_quote, m_crm_type_relationship 
                  WHERE m_crm_type_relationship.type=8
                        AND m_crm_type_relationship.type1id=m_crm_quote.id
                        AND m_crm_quote.id=#{quoteId.value,javaType=INTEGER}
                        AND m_crm_type_relationship.type2id=m_crm_opportunity.id) > 0
          ]]>
        </if>
        <if test="assignUserName != null">
            <![CDATA[
            ${assignUserName.operation}
            (SELECT COUNT(*)
            FROM s_user 
            WHERE m_crm_opportunity.assignUser = s_user.username 
                AND (concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) like '%${assignUserName.value}%')) > 0
            ]]>
        </if>
        <if test="assignUser != null">
            <![CDATA[
            ${assignUser.operation}
            m_crm_opportunity.assignUser = #{assignUser.value}
            ]]>
        </if>
        <if test="saccountid != null">
            <![CDATA[${saccountid.operation} m_crm_opportunity.sAccountId = #{saccountid.value,javaType=INTEGER}]]>
        </if>
    </sql>

    <sql id="selectSimpleOpportunity">
        <![CDATA[
        select m_crm_opportunity.id, m_crm_opportunity.opportunityName, m_crm_opportunity.currencyid, m_crm_opportunity.accountid, 
               m_crm_opportunity.amount, m_crm_opportunity.type, m_crm_opportunity.source, m_crm_opportunity.expectedClosedDate,
               m_crm_opportunity.campaignid, m_crm_opportunity.nextStep, m_crm_opportunity.probability, m_crm_opportunity.description, 
               m_crm_opportunity.createdTime, m_crm_opportunity.createdUser, m_crm_opportunity.sAccountId, m_crm_opportunity.assignUser, 
               m_crm_opportunity.opportunityType, m_crm_opportunity.salesStage,
               concat(s_user.firstname, IFNULL(concat(' ', s_user.middlename, ' '), ' '), s_user.lastname) AS assignUserFullName,
               m_crm_account.accountName, m_crm_campaign.campaignName
               
      
        FROM m_crm_opportunity
               LEFT OUTER JOIN m_crm_account ON (m_crm_opportunity.accountid=m_crm_account.id)
               LEFT OUTER JOIN s_user ON (m_crm_opportunity.assignUser = s_user.username)
               LEFT OUTER JOIN m_crm_campaign ON (m_crm_opportunity.campaignid = m_crm_campaign.id) 
        ]]>
    </sql>

    <select id="getTotalCount" resultType="int"
        parameterType="OpportunitySearchCriteria">
        SELECT count(*) as totalCount FROM m_crm_opportunity
        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 <include refid="com.esofthead.mycollab.module.crm.dao.OpportunityMapperExt.queryTotalCountSearchCriteria" />
        </trim>
    </select>

    <select id="findPagableListByCriteria" resultMap="SimpleOpportunityResult"
        parameterType="OpportunitySearchCriteria">
        <include refid="com.esofthead.mycollab.module.crm.dao.OpportunityMapperExt.selectSimpleOpportunity" />

        <trim prefix="WHERE" prefixOverrides="AND | OR ">
            1=1 <include refid="com.esofthead.mycollab.module.crm.dao.OpportunityMapperExt.querySearchCriteria" />
       </trim>
    </select>

    <select id="findOpportunityById" parameterType="int"
        resultMap="SimpleOpportunityResult">
        <include refid="com.esofthead.mycollab.module.crm.dao.OpportunityMapperExt.selectSimpleOpportunity" />

        WHERE m_crm_opportunity.id=#{opportunityId,javaType=INTEGER}
    </select>
</mapper>