<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycollab.module.tracker.dao.RelatedBugMapperExt">

    <resultMap id="SimpleRelatedBugResult" type="com.mycollab.module.tracker.domain.SimpleRelatedBug">
        <result column="id" jdbcType="INTEGER" property="id"/>
        <result column="relatedType" jdbcType="VARCHAR" property="relatedType"/>
        <result column="isRelated" jdbcType="BOOLEAN" property="related"/>
        <association property="relatedBug" javaType="com.mycollab.module.project.domain.BugWithBLOBs"
                     resultMap="com.mycollab.module.project.dao.BugMapper.ResultMapWithBLOBs" columnPrefix="related_">
        </association>
    </resultMap>

    <select id="findRelatedBugs" parameterType="int" resultMap="SimpleRelatedBugResult" lang="velocity">
        <![CDATA[
            (SELECT DISTINCT m_tracker_related_bug.relatetype AS relatedType, m_tracker_related_bug.id, 1 AS isRelated,
              m_prj_bug.id as related_id, m_prj_bug.name AS related_name, m_prj_bug.assignUser AS related_assignUser,
              m_prj_bug.createdTime AS related_createdTime, m_prj_bug.createdUser AS related_createdUser, m_prj_bug.severity,
              m_prj_bug.priority AS related_priority, m_prj_bug.lastUpdatedTime AS related_lastUpdatedTime,
              m_prj_bug.status AS related_status, m_prj_bug.duedate AS related_duedate, m_prj_bug.resolution AS related_resolution,
              m_prj_bug.projectId As related_projectId, m_prj_bug.resolveddate AS related_resolveddate,
              m_prj_bug.originalEstimate AS related_originalEstimate, m_prj_bug.remainEstimate AS related_remainEstimate,
              m_prj_bug.sAccountId AS related_sAccountId, m_prj_bug.milestoneId AS related_milestoneId,
              m_prj_bug.bugkey AS related_bugkey, m_prj_bug.bugIndex AS related_bugIndex,
              m_prj_bug.startDate AS related_startDate, m_prj_bug.endDate AS related_endDate,
              m_prj_bug.percentagecomplete AS related_percentagecomplete,
              m_prj_bug.detail AS related_detail, m_prj_bug.environment AS related_environment,
              m_prj_bug.description AS related_description
            FROM m_prj_bug, m_tracker_related_bug
            WHERE m_tracker_related_bug.bugid = @{bugId}
                AND m_tracker_related_bug.relatedid = m_prj_bug.id)
            UNION
            (SELECT DISTINCT m_tracker_related_bug.relatetype AS relatedType, m_tracker_related_bug.id, 0 AS isRelated,
              m_prj_bug.id as related_id, m_prj_bug.name AS related_name, m_prj_bug.assignUser AS related_assignUser,
              m_prj_bug.createdTime AS related_createdTime, m_prj_bug.createdUser AS related_createdUser, m_prj_bug.severity,
              m_prj_bug.priority AS related_priority, m_prj_bug.lastUpdatedTime AS related_lastUpdatedTime,
              m_prj_bug.status AS related_status, m_prj_bug.duedate AS related_duedate, m_prj_bug.resolution AS related_resolution,
              m_prj_bug.projectId As related_projectId, m_prj_bug.resolveddate AS related_resolveddate,
              m_prj_bug.originalEstimate AS related_originalEstimate, m_prj_bug.remainEstimate AS related_remainEstimate,
              m_prj_bug.sAccountId AS related_sAccountId, m_prj_bug.milestoneId AS related_milestoneId,
              m_prj_bug.bugkey AS related_bugkey, m_prj_bug.bugIndex AS related_bugIndex,
              m_prj_bug.startDate AS related_startDate, m_prj_bug.endDate AS related_endDate,
              m_prj_bug.percentagecomplete AS related_percentagecomplete,
              m_prj_bug.detail AS related_detail, m_prj_bug.environment AS related_environment,
              m_prj_bug.description AS related_description
            FROM m_prj_bug, m_tracker_related_bug
            WHERE m_tracker_related_bug.bugid = m_prj_bug.id AND m_tracker_related_bug.relatedid = @{bugId})
            ORDER BY relatedType
        ]]>
    </select>

</mapper>